<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微服务设计 | 墨语笔记补完</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="日常读书笔记、每日的文章阅读重要部分注记录">
    <meta property="article:modified_time" content="2019-08-24T08:00:27.000Z">
    <meta property="og:site_name" content="墨语笔记补完">
    <meta property="og:title" content="微服务设计">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/other/BuildingMicroservices.html">
    <meta name="twitter:title" content="微服务设计">
    <meta name="twitter:url" content="/other/BuildingMicroservices.html">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="preload" href="/assets/css/0.styles.36294c82.css" as="style"><link rel="preload" href="/assets/js/app.cccfd8e7.js" as="script"><link rel="preload" href="/assets/js/2.9de5c6c1.js" as="script"><link rel="preload" href="/assets/js/13.1ba667dd.js" as="script"><link rel="prefetch" href="/assets/js/10.d6241704.js"><link rel="prefetch" href="/assets/js/11.67fb7f7f.js"><link rel="prefetch" href="/assets/js/12.e5c25b76.js"><link rel="prefetch" href="/assets/js/14.cf11d9fa.js"><link rel="prefetch" href="/assets/js/15.4956305a.js"><link rel="prefetch" href="/assets/js/16.2c48f3c9.js"><link rel="prefetch" href="/assets/js/17.478a5e4c.js"><link rel="prefetch" href="/assets/js/18.f6c443cd.js"><link rel="prefetch" href="/assets/js/19.782e6682.js"><link rel="prefetch" href="/assets/js/20.9497fcb7.js"><link rel="prefetch" href="/assets/js/21.14aafb81.js"><link rel="prefetch" href="/assets/js/22.2668548e.js"><link rel="prefetch" href="/assets/js/23.e18d4f59.js"><link rel="prefetch" href="/assets/js/24.0494627e.js"><link rel="prefetch" href="/assets/js/25.e6d2f928.js"><link rel="prefetch" href="/assets/js/26.5b3e12f5.js"><link rel="prefetch" href="/assets/js/27.2ea04455.js"><link rel="prefetch" href="/assets/js/28.f54943d4.js"><link rel="prefetch" href="/assets/js/29.0d21d124.js"><link rel="prefetch" href="/assets/js/3.7c1461c0.js"><link rel="prefetch" href="/assets/js/30.51e7e3da.js"><link rel="prefetch" href="/assets/js/31.b6fd8416.js"><link rel="prefetch" href="/assets/js/32.288e3649.js"><link rel="prefetch" href="/assets/js/33.2fed9cff.js"><link rel="prefetch" href="/assets/js/34.4c6a8953.js"><link rel="prefetch" href="/assets/js/35.64749222.js"><link rel="prefetch" href="/assets/js/36.d523088c.js"><link rel="prefetch" href="/assets/js/37.df0319c9.js"><link rel="prefetch" href="/assets/js/38.1281fec2.js"><link rel="prefetch" href="/assets/js/39.090c1406.js"><link rel="prefetch" href="/assets/js/4.a7183ff4.js"><link rel="prefetch" href="/assets/js/40.54ef8cf7.js"><link rel="prefetch" href="/assets/js/41.36e152bb.js"><link rel="prefetch" href="/assets/js/42.7c813979.js"><link rel="prefetch" href="/assets/js/43.6b73d645.js"><link rel="prefetch" href="/assets/js/44.0f59db0e.js"><link rel="prefetch" href="/assets/js/45.2a5cf763.js"><link rel="prefetch" href="/assets/js/46.6d860222.js"><link rel="prefetch" href="/assets/js/47.c5dc6374.js"><link rel="prefetch" href="/assets/js/48.22502cc5.js"><link rel="prefetch" href="/assets/js/49.446fdcce.js"><link rel="prefetch" href="/assets/js/5.86c48d13.js"><link rel="prefetch" href="/assets/js/50.505b1863.js"><link rel="prefetch" href="/assets/js/6.dd5bb6a5.js"><link rel="prefetch" href="/assets/js/7.b915e335.js"><link rel="prefetch" href="/assets/js/8.340fe880.js"><link rel="prefetch" href="/assets/js/9.b4c5caee.js">
    <link rel="stylesheet" href="/assets/css/0.styles.36294c82.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">墨语笔记补完</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://www.idwangmo.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  墨语的后花园
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/idwangmo/note" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://www.idwangmo.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  墨语的后花园
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/idwangmo/note" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>微服务设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/other/BuildingMicroservices.html#第一章" class="sidebar-link">第一章</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#微服务定义" class="sidebar-link">微服务定义</a></li><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#微服务大好处" class="sidebar-link">微服务大好处</a></li></ul></li><li><a href="/other/BuildingMicroservices.html#第二章" class="sidebar-link">第二章</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#演进式架构师应该承担的职责" class="sidebar-link">演进式架构师应该承担的职责</a></li></ul></li><li><a href="/other/BuildingMicroservices.html#第三章" class="sidebar-link">第三章</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/other/BuildingMicroservices.html#第四章" class="sidebar-link">第四章</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#理想大集成技术" class="sidebar-link">理想大集成技术</a></li><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#版本管理" class="sidebar-link">版本管理</a></li></ul></li><li><a href="/other/BuildingMicroservices.html#第五章" class="sidebar-link">第五章</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#部署" class="sidebar-link">部署</a></li><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#测试分类" class="sidebar-link">测试分类</a></li></ul></li><li><a href="/other/BuildingMicroservices.html#第八章-监控" class="sidebar-link">第八章 监控</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/other/BuildingMicroservices.html#第九章" class="sidebar-link">第九章</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#身份验证和授权" class="sidebar-link">身份验证和授权</a></li><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#服务间的身份验证和授权" class="sidebar-link">服务间的身份验证和授权</a></li><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#静态数据的安全" class="sidebar-link">静态数据的安全</a></li><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#深度防御" class="sidebar-link">深度防御</a></li></ul></li><li><a href="/other/BuildingMicroservices.html#第十章" class="sidebar-link">第十章</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/other/BuildingMicroservices.html#共享服务的原因" class="sidebar-link">共享服务的原因</a></li></ul></li><li><a href="/other/BuildingMicroservices.html#第十一章" class="sidebar-link">第十一章</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><em>如何寻找平衡</em></p> <h2 id="第一章"><a href="#第一章" class="header-anchor">#</a> 第一章</h2> <h3 id="微服务定义"><a href="#微服务定义" class="header-anchor">#</a> 微服务定义</h3> <ol><li>很小，专注于做好一件事情
<ul><li>内聚性是指将相关代码放在一起</li> <li>根据业务大边界来确定服务大边界</li> <li>服务能够和团队相匹配</li></ul></li> <li>自治性</li></ol> <h3 id="微服务大好处"><a href="#微服务大好处" class="header-anchor">#</a> 微服务大好处</h3> <ol><li>技术异构性</li> <li>弹性</li> <li>扩展</li> <li>简化部署</li> <li>与组织结构相匹配</li> <li>可组合性</li> <li>对可替代性大优化</li></ol> <p>服务与服务之间可以并且应该大量使用第三方库来重用公共代码，但有时候效果不太好</p> <h2 id="第二章"><a href="#第二章" class="header-anchor">#</a> 第二章</h2> <p>人们试图通过大量的图表和文档创建出一个完美的方案，而忽略了很多基础性的未知因素</p> <h4 id="一个原则性的方法"><a href="#一个原则性的方法" class="header-anchor">#</a> 一个原则性的方法</h4> <ol><li>战略目标</li> <li>原则</li> <li>实践：实践应该巩固原则</li> <li>将原则和实践相结合</li></ol> <p>日志功能和监控功能都需要集中式管理</p> <p>一个运行异常的服务可能会毁了整个系统，所以必须保证每个服务都可以应对下游服务的错误请求</p> <p>对以下几种请求做不同的处理可以帮助系统及时失败，并且也很容易追溯问题：</p> <ol><li>正常且被正确处理大请求</li> <li>错误请求，并且服务识别出了它是错误的，但什么都没做</li> <li>被房屋的服务宕机了，所以无法判断请求是否正常</li></ol> <p><strong>治理</strong>通过评估干系人的需求、当前情况及下一步的可能性来确保企业目标的达成，通过排优先级和做决策来设定方向。对于已经达成一致的方向和目标进行监督。</p> <h3 id="演进式架构师应该承担的职责"><a href="#演进式架构师应该承担的职责" class="header-anchor">#</a> 演进式架构师应该承担的职责</h3> <ul><li>愿景</li> <li>同理心</li> <li>合作</li> <li>适应性</li> <li>自治性</li> <li>治理</li></ul> <h2 id="第三章"><a href="#第三章" class="header-anchor">#</a> 第三章</h2> <p>当考虑微服务的边界时，首先考虑比较大的、粗粒度的那些上下文，然后当发现合适的缝隙后，再进一步划分出那些嵌套的上下文。</p> <p>修改系统的目的是为了满足业务需求</p> <h2 id="第四章"><a href="#第四章" class="header-anchor">#</a> 第四章</h2> <h3 id="理想大集成技术"><a href="#理想大集成技术" class="header-anchor">#</a> 理想大集成技术</h3> <ol><li>避免破坏性修改</li> <li>保证 API 的技术无关性</li> <li>服务易于消费方使用</li> <li>隐藏内部实现细节</li></ol> <p><code>PRC</code>的核心思想是隐藏远程调用大复杂性。</p> <p>使用<code>RPC</code>需要注意不要对远程调用过度抽象，以至于网络因素完全被隐藏起来；确保可以独立大升级服务端接口而不用强迫客户端升级，所以在编写客户端代码时要注意这方面大平衡；在客户端中一定不要隐藏我们是在做网络调用这个事实。</p> <p>尽量让中间件保持简单，而把业务逻辑放在自己的服务中</p> <p>在微服务内部不要违反 DRY，但在跨服务的情况下可以适当违反 DRY</p> <p>想要使用客户端库，一定要保证其中只包含处理底层传输协议的代码</p> <h3 id="版本管理"><a href="#版本管理" class="header-anchor">#</a> 版本管理</h3> <ol><li>尽可能推迟</li> <li>及早发现破坏性修改</li> <li>使用语义化的版本管理</li> <li>不同大接口共存</li> <li>同时使用多个版本的服务</li></ol> <p>最大程度地保证微服务之间的低耦合：</p> <ul><li>无论如何避免数据库集成</li> <li>理解 REST 和 RPC 之间的取舍，但总是使用 REST 作为请求 / 响应模式的起点</li> <li>相比编排，优先选择协同</li> <li>避免破坏性修改、理解 Postel 法则、使用容错性读取器</li> <li>将用户界面视为一个组合层</li></ul> <h2 id="第五章"><a href="#第五章" class="header-anchor">#</a> 第五章</h2> <p>限界上下文就是一个非常好的接缝，因为它的定义就是组织内高内聚和低耦合的边界</p> <h3 id="部署"><a href="#部署" class="header-anchor">#</a> 部署</h3> <p>是否理解 CI 的三个问题：</p> <ul><li>是否每天签入代码到主线</li> <li>是否有一组测试来验证修改</li> <li>当构建失败后，团队是否把修复 CI 当作第一优先级的事情来做</li></ul> <p>使用 OS 特定构建物的好处是，在做部署时不需要考虑底层使用的是什么技术。只需要简单使用内置的工具就可以完成软件的安装</p> <p><img src="/assets/img/scrum-test.a31a1d93.png" alt="Scrum 测试金子塔">_</p> <h3 id="测试分类"><a href="#测试分类" class="header-anchor">#</a> 测试分类</h3> <ol><li>单元测试</li> <li>服务测试</li> <li>端到端测试</li></ol> <p>测试场景，而是故事（scrum 中的 stroy）</p> <p><img src="/assets/img/cdc-test.405e6a6b.png" alt="契约测试场景金字塔"></p> <h2 id="第八章-监控"><a href="#第八章-监控" class="header-anchor">#</a> 第八章 监控</h2> <p>对每个服务而言：</p> <ul><li>最低限度要跟踪请求响应时间。做好之后，可以开始跟踪错误率及应用程序级的指标。</li> <li>最低限度要跟踪所有下游服务的健康状态，包括下游调用的响应时间，最好能够跟踪错误率。一些像 Hystrix 这样的库，可以在这方面提供帮助。</li> <li>标准化如何收集指标以及存储指标。</li> <li>如果可能的话，以标准的格式将日志记录到一个标准的位置。如果每个服务各自使用不同的方式，聚合会非常痛苦！</li> <li>监控底层操作系统，这样你就可以跟踪流氓进程和进行容量规划。</li></ul> <p>对系统而言：</p> <ul><li>聚合 CPU 之类的主机层级的指标及应用程序级指标。</li> <li>确保你选用的指标存储工具可以在系统和服务级别做聚合，同时也允许你查看单台主机的情况。</li> <li>确保指标存储工具允许你维护数据足够长的时间，以了解你的系统的趋势。</li> <li>使用单个可查询工具来对日志进行聚合和存储。</li> <li>强烈考虑标准化关联标识的使用。</li> <li>了解什么样的情况需要行动，并根据这些信息构造相应的警报和仪表盘。</li> <li>调查对各种指标聚合方式做统一化的可能性，像 Suro 或 Riemann 这样的工具可能会对 你有用。</li></ul> <h2 id="第九章"><a href="#第九章" class="header-anchor">#</a> 第九章</h2> <p><img src="/assets/img/sso-gateway.fefca195.png" alt="单点网关登录"></p> <p><strong>不要实现自己的加密算法。不要发明自己的安全协议</strong></p> <h3 id="身份验证和授权"><a href="#身份验证和授权" class="header-anchor">#</a> 身份验证和授权</h3> <ol><li>单点登录</li> <li>网关单点登录</li> <li>细粒度的授权</li></ol> <h3 id="服务间的身份验证和授权"><a href="#服务间的身份验证和授权" class="header-anchor">#</a> 服务间的身份验证和授权</h3> <ol><li>在边界内允许一切</li> <li>HTTP(s) 基本身份验证</li> <li>使用<code>SAML</code>或<code>OpenID</code></li> <li>客户端证书</li> <li><code>HTTP</code>之上的<code>HMAC</code></li> <li>API 密钥</li> <li>代理</li></ol> <h3 id="静态数据的安全"><a href="#静态数据的安全" class="header-anchor">#</a> 静态数据的安全</h3> <ol><li>使用众所周知的加密算法</li> <li>按需解密</li> <li>加密备份</li></ol> <h3 id="深度防御"><a href="#深度防御" class="header-anchor">#</a> 深度防御</h3> <ol><li>防火墙</li> <li>日志</li> <li>入侵检测</li></ol> <h2 id="第十章"><a href="#第十章" class="header-anchor">#</a> 第十章</h2> <p><strong>康威定则</strong>：任何组织在设计一套系统（广义概念上的系统）时，所交付的设计方案在结构上都与该组织的沟通结构保持一致。</p> <h3 id="共享服务的原因"><a href="#共享服务的原因" class="header-anchor">#</a> 共享服务的原因</h3> <ol><li>难以分割</li> <li>特性团队</li> <li>交付瓶颈</li></ol> <h2 id="第十一章"><a href="#第十一章" class="header-anchor">#</a> 第十一章</h2> <p>规模化后，需要假定故障毁发生，并为故障进行准备，那么这样就会作出不同的权衡</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次修改:</span> <span class="time">8/24/2019, 4:00:27 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cccfd8e7.js" defer></script><script src="/assets/js/2.9de5c6c1.js" defer></script><script src="/assets/js/13.1ba667dd.js" defer></script>
  </body>
</html>
